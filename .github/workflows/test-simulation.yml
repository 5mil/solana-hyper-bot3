name: Test Simulation

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Number of iterations'
        required: false
        default: '1000'
        type: string
      execute_trades:
        description: 'Execute trades in simulation'
        required: false
        default: true
        type: boolean

jobs:
  simulation:
    name: High-Fidelity Simulation
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run extended simulation
        id: sim
        run: |
          ITERATIONS=${{ inputs.iterations || '1000' }}
          EXECUTE_FLAG=${{ inputs.execute_trades == true && '--execute-trades' || '' }}
          
          echo "Running simulation with $ITERATIONS iterations..."
          python tools/run_simulation.py \
            --iterations $ITERATIONS \
            $EXECUTE_FLAG \
            --output data/extended_simulation_report.json
          
          echo "Simulation complete"
      
      - name: Analyze results
        id: analyze
        run: |
          python -c "
          import json
          import sys
          
          with open('data/extended_simulation_report.json') as f:
              data = json.load(f)
          
          summary = data['summary']
          perf = summary['trading_performance']
          
          # Extract metrics
          win_rate = perf['win_rate']
          return_pct = perf['return_pct']
          total_trades = perf['total_trades']
          winning_trades = perf['winning_trades']
          losing_trades = perf['losing_trades']
          
          # Compute monthly return (assuming 1000 iterations ~ 1 month)
          iterations = summary['total_iterations']
          monthly_return = return_pct  # Simplified
          
          # Compute max drawdown (simplified)
          max_drawdown = abs(min(0, return_pct)) if return_pct < 0 else 0
          
          print('=' * 60)
          print('SIMULATION RESULTS')
          print('=' * 60)
          print(f'Total Iterations: {iterations}')
          print(f'Total Trades: {total_trades}')
          print(f'Winning Trades: {winning_trades}')
          print(f'Losing Trades: {losing_trades}')
          print(f'Win Rate: {win_rate:.1%}')
          print(f'Total Return: {return_pct:.1f}%')
          print(f'Monthly Return: {monthly_return:.1f}%')
          print(f'Max Drawdown: {max_drawdown:.1f}%')
          print('=' * 60)
          
          # Set outputs
          with open('$GITHUB_OUTPUT', 'a') as out:
              out.write(f'win_rate={win_rate:.3f}\n')
              out.write(f'return_pct={return_pct:.2f}\n')
              out.write(f'monthly_return={monthly_return:.2f}\n')
              out.write(f'max_drawdown={max_drawdown:.2f}\n')
              out.write(f'total_trades={total_trades}\n')
          
          # Enforce thresholds
          print('\nTHRESHOLD CHECKS')
          print('=' * 60)
          
          passed = True
          
          # Check win rate >= 90%
          if win_rate >= 0.90:
              print('‚úÖ Win Rate: {:.1%} (>= 90%)'.format(win_rate))
          else:
              print('‚ùå Win Rate: {:.1%} (< 90% FAIL)'.format(win_rate))
              passed = False
          
          # Check monthly return >= 45%
          if monthly_return >= 45:
              print('‚úÖ Monthly Return: {:.1f}% (>= 45%)'.format(monthly_return))
          else:
              print('‚ö†Ô∏è  Monthly Return: {:.1f}% (< 45% WARNING)'.format(monthly_return))
              # Not a hard fail, just warning
          
          # Check max drawdown <= 10%
          if max_drawdown <= 10:
              print('‚úÖ Max Drawdown: {:.1f}% (<= 10%)'.format(max_drawdown))
          else:
              print('‚ùå Max Drawdown: {:.1f}% (> 10% FAIL)'.format(max_drawdown))
              passed = False
          
          print('=' * 60)
          
          if not passed:
              print('\n‚ùå SIMULATION FAILED THRESHOLDS')
              print('Production promotion blocked.')
              sys.exit(1)
          else:
              print('\n‚úÖ SIMULATION PASSED ALL THRESHOLDS')
              print('Ready for production promotion.')
          "
      
      - name: Upload simulation artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: simulation-results
          path: |
            data/extended_simulation_report.json
            data/performance_stats.json
            data/simulation_stats.json
      
      - name: Create summary
        if: always()
        run: |
          echo "## üìä Simulation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Win Rate**: ${{ steps.analyze.outputs.win_rate }}" >> $GITHUB_STEP_SUMMARY
          echo "**Return**: ${{ steps.analyze.outputs.return_pct }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Total Trades**: ${{ steps.analyze.outputs.total_trades }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Thresholds" >> $GITHUB_STEP_SUMMARY
          echo "- Win Rate: >= 90%" >> $GITHUB_STEP_SUMMARY
          echo "- Monthly Return: >= 45%" >> $GITHUB_STEP_SUMMARY
          echo "- Max Drawdown: <= 10%" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Simulation failed thresholds"
          echo "Review artifacts for detailed analysis"
          echo "Production promotion is blocked until thresholds are met"
